# =====================================
# VitalStack - Docker Compose
# =====================================
# Production deployment configuration
# Uses pre-built images from GitHub Container Registry

services:
  # ----- Go API -----
  api:
    image: ghcr.io/dogab/vitalstack-api:latest
    container_name: vitalstack-api
    restart: unless-stopped
    ports:
      - "8080:8080"
    environment:
      # Logging
      LOGGING_LEVEL: info
      LOGGING_ENCODING: json
      # Server
      SERVER_ADDR: "0.0.0.0:8080"
      SERVER_ORIGIN: "https://vs.dgit.ch"
      # AI (Genkit)
      GEMINI_API_KEY: ${GEMINI_API_KEY}
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/api/health"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s

  # ----- SvelteKit Frontend -----
  web:
    image: ghcr.io/dogab/vitalstack-web:latest
    container_name: vitalstack-web
    restart: unless-stopped
    ports:
      - "3000:3000"
    environment:
      NODE_ENV: production
      PORT: 3000
      # Public URL for CORS/cookies
      ORIGIN: https://vs.dgit.ch
      # API URL for browser requests (runtime configuration)
      PUBLIC_API_URL: https://vs-api.dgit.ch
    depends_on:
      api:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s

networks:
  default:
    name: vitalstack-network
